---
import { getCollection } from 'astro:content';
import EventsList from '@components/events/EventsList.astro';
import NewsList from '@components/news/NewsList.astro';
import Base from '@layouts/Base.astro';
import { groupByTag } from '../../util/group-by-tag';

export async function getStaticPaths() {
  const [allNews, allEvents] = await Promise.all([
    getCollection('news'),
    getCollection('events'),
  ]);

  const newsMap = groupByTag(allNews);
  const eventsMap = groupByTag(allEvents);

  const allTags = new Set([...newsMap.keys(), ...eventsMap.keys()]);

  return [...allTags].map((tag) => ({
    params: { slug: tag },
    props: {
      tag,
      news: (newsMap.get(tag) ?? []).sort(
        (a, b) => b.data.date.getTime() - a.data.date.getTime(),
      ),
      events: (eventsMap.get(tag) ?? []).sort(
        (a, b) => b.data.date.getTime() - a.data.date.getTime(),
      ),
    },
  }));
}

const { tag, news, events } = Astro.props;
---

<Base title={`Tagged: ${tag}`}>

  <section class="usa-section">
    <div class="grid-container">

      <h1>Tagged: {tag}</h1>

      {news.length > 0 && (
        <section class="margin-top-4">
          <h2 class="font-heading-lg margin-bottom-2">News</h2>
          <NewsList items={news} />
        </section>
      )}

      {events.length > 0 && (
        <section class="margin-top-4">
          <h2 class="font-heading-lg margin-bottom-2">Events</h2>
          <EventsList items={events} />
        </section>
      )}

    </div>
  </section>

</Base>
